/* global L, console, foursq_client_id, foursq_client_secret, zooms, lastfm_api_key */(function(){function s(){$.each(n,function(t,n){e.getBounds().contains(n.getLatLng())?e.addLayer(n):e.removeLayer(n)});$.each(i,function(t,n){e.getBounds().contains(n.getLatLng())?e.addLayer(n):e.removeLayer(n)})}function o(e){var r=L.icon({iconUrl:"img/beer.png",iconSize:[32,32],popupAnchor:[0,-16]}),i=new L.marker([e.location.lat,e.location.lng],{title:e.name,icon:r});console.log(e);i.bindPopup("<h1>"+e.name+"</h1>");if(t.indexOf(e.id)<=-1){t.push(e.id);n.push(i)}}function u(e){var t=L.icon({iconUrl:"img/music.png",iconSize:[32,32],popupAnchor:[0,-16]}),n=new L.marker([e.venue.location["geo:point"]["geo:lat"],e.venue.location["geo:point"]["geo:long"]],{title:e.title,icon:t});n.bindPopup("<h1>"+e.title+"</h1><h3>"+e.startDate+"</h3><p>"+e.venue.name+"</p>");if(r.indexOf(e.id)<=-1){r.push(e.id);i.push(n)}}function a(e){console.log("not implemented yet! - showError "+e)}function f(e){a(e)}function l(){console.log("not implemented yet! - onLocationFound")}function c(){var t=e.getCenter(),n=t.lat+","+t.lng,r=Math.max(e.getSize().x,e.getSize().y),i=e.getZoom(),a=zooms[i]*r;$.getJSON("https://api.foursquare.com/v2/venues/search",{ll:n,radius:a,limit:50,intent:"browse",categoryId:"4bf58dd8d48988d155941735,4bf58dd8d48988d11b941735,4d4b7105d754a06376d81259",client_id:foursq_client_id,client_secret:foursq_client_secret,v:20130420}).done(function(e){$.each(e.response.venues,function(e,t){o(t)});s()});$.getJSON("http://ws.audioscrobbler.com/2.0/",{method:"geo.getevents","long":t.lng,lat:t.lat,api_key:lastfm_api_key,limit:30,format:"json",distance:a/1e3}).done(function(e){$.each(e.events.event,function(e,t){u(t)});s()})}function h(){var t="http://{s}.tile.cloudmade.com/364b324514d240c8afdd7ba132fd4841/997/256/{z}/{x}/{y}.png",n="Map data Â© OpenStreetMap contributors",r=new L.TileLayer(t,{minZoom:8,maxZoom:18,attribution:n});e.addLayer(r);e.locate({setView:!0,maxZoom:16});e.on("locationerror",f);e.on("locationfound",l);e.on("moveend",c)}var e=L.map("map"),t=[],n=[],r=[],i=[];h()})();